#include "stm32f10x.h"
#include "IIC_5883.h"
#include "delay_5883.h"

void I2C_GPIO_Config(void)
{
	GPIO_InitTypeDef GPIO_InitStructure;
	RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOB, ENABLE); //使能GPIOB时钟

	GPIO_InitStructure.GPIO_Pin = GPIO_Pin_12 | GPIO_Pin_13;
	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_Out_PP; //推挽输出
	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
	GPIO_Init(GPIOB, &GPIO_InitStructure);
	GPIO_SetBits(GPIOB, GPIO_Pin_12 | GPIO_Pin_13); //PB6,PB7 输出高
}

u8 I2C_Start(void)
{
	SDA_H;
	SCL_H;
	I2C_delay();
	if (!SDA_read)
		return 0; //SDA线为低电平则总线忙,退出
	SDA_L;
	I2C_delay();
	if (SDA_read)
		return 0; //SDA线为高电平则总线出错,退出
	SDA_L;
	I2C_delay();
	return 1;
}
void I2C_Stop(void)
{
	SCL_L;
	I2C_delay();
	SDA_L;
	I2C_delay();
	SCL_H;
	I2C_delay();
	SDA_H;
	I2C_delay();
}
void I2C_Ack(void)
{
	SCL_L;
	I2C_delay();
	SDA_L;
	I2C_delay();
	SCL_H;
	I2C_delay();
	SCL_L;
	I2C_delay();
}
void I2C_NoAck(void)
{
	SCL_L;
	I2C_delay();
	SDA_H;
	I2C_delay();
	SCL_H;
	I2C_delay();
	SCL_L;
	I2C_delay();
}
u8 I2C_WaitAck(void) //返回为:=1有ACK,=0无ACK
{
	SCL_L;
	I2C_delay();
	SDA_H;
	I2C_delay();
	SCL_H;
	I2C_delay();
	if (SDA_read)
	{
		SCL_L;
		I2C_delay();
		return 0;
	}
	SCL_L;
	I2C_delay();
	return 1;
}
void I2C_SendByte(u8 SendByte) //数据从高位到低位//
{
	u8 i = 8;
	while (i--)
	{
		SCL_L;
		I2C_delay();
		if (SendByte & 0x80)
			SDA_H;
		else
			SDA_L;
		SendByte <<= 1;
		I2C_delay();
		SCL_H;
		I2C_delay();
	}
	SCL_L;
}
unsigned char I2C_RadeByte(void) //数据从高位到低位//
{
	u8 i = 8;
	u8 ReceiveByte = 0;

	SDA_H;
	while (i--)
	{
		ReceiveByte <<= 1;
		SCL_L;
		I2C_delay();
		SCL_H;
		I2C_delay();
		if (SDA_read)
		{
			ReceiveByte |= 0x01;
		}
	}
	SCL_L;
	return ReceiveByte;
}
